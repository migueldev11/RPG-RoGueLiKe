<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>RPGLiKe — Guardian Edition</title>
<style>
  :root {
    --bg: #050505; --panel: #111; --border: #222;
    --player: #4f4; --enemy: #f55; --item: #ff5;
    --stairs: #5ff; --text: #888;
  }
  * { box-sizing: border-box; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
  body {
    margin: 0; background: var(--bg); color: var(--text);
    font-family: 'Courier New', Courier, monospace;
    height: 100vh; display: flex; flex-direction: column; overflow: hidden;
  }

  /* --- UI BAR --- */
  #game-ui { display: flex; flex-direction: column; width: 100%; height: 100%; padding: 5px; }
  #stats-bar {
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px;
    background: var(--panel); border: 1px solid var(--border);
    padding: 8px; font-size: 10px; margin-bottom: 5px;
  }
  .stat-val { display: block; font-weight: bold; color: #fff; font-size: 11px; }
  #msg-log {
    height: 40px; background: #000; padding: 4px; font-size: 10px;
    border: 1px solid #1a1a1a; margin-bottom: 5px; overflow: hidden;
  }

  /* --- MAPA --- */
  #map-view {
    flex: 1; background: #000; border: 1px solid var(--border);
    display: flex; align-items: center; justify-content: center; overflow: hidden;
    position: relative;
  }
  #ascii-map { white-space: pre; line-height: 1.1; font-size: 3vw; font-weight: bold; }
  @media (min-width: 600px) { #ascii-map { font-size: 14px; } }

  .p { color: var(--player); } .e { color: var(--enemy); }
  .i { color: var(--item); } .s { color: var(--stairs); }
  .w { color: #222; } .f { color: #0a0a0a; }

  /* --- SHOP --- */
  #shop-ui {
    position: absolute; inset: 10px; background: rgba(5,5,5,0.98);
    border: 1px solid #444; z-index: 100; padding: 15px;
    display: none; flex-direction: column;
  }
  .shop-grid { display: grid; gap: 8px; }
  .shop-item { background: #151515; border: 1px solid #333; padding: 8px; display: flex; justify-content: space-between; align-items: center; font-size: 11px; }
  .buy-btn { background: #440; color: #ff5; border: none; padding: 4px 8px; font-weight: bold; }

  /* --- CONTROLES EM CRUZ --- */
  #controls {
    height: 190px; display: grid; grid-template-columns: 1.2fr 1fr; gap: 10px;
    padding: 10px; background: var(--panel); border-top: 1px solid var(--border);
  }
  .dpad { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); width: 140px; height: 140px; }
  .btn { background: #1a1a1a; border: 1px solid #333; color: #eee; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 22px; width: 45px; height: 45px; }
  #b-u { grid-area: 1 / 2; } #b-l { grid-area: 2 / 1; } #b-r { grid-area: 2 / 3; } #b-d { grid-area: 3 / 2; }
  
  .actions { display: flex; flex-direction: column; gap: 6px; justify-content: center; }
  .btn-act { width: 100%; height: 40px; font-size: 10px; font-weight: bold; background: #1a1a1a; border: 1px solid #333; border-left: 4px solid #fff; color: #fff; }

  .shake { animation: shake 0.15s ease-in-out; }
  @keyframes shake { 0%, 100% { transform: translate(0,0); } 25% { transform: translate(-4px, 2px); } 75% { transform: translate(4px, -2px); } }
</style>
</head>
<body>

<div id="scr-game" class="screen">
  <div id="game-ui">
    <div id="stats-bar">
      <div>HP <span id="u-hp" class="stat-val">0</span></div>
      <div>ATK/DEF <span id="u-atkdef" class="stat-val">0/0</span></div>
      <div>ANDAR <span id="u-flr" class="stat-val">1</span></div>
      <div>GOLD <span id="u-gld" class="stat-val">0</span></div>
    </div>
    <div id="msg-log">Sinta o medo da escuridão...</div>
    
    <div id="map-view">
      <div id="ascii-map"></div>
      <div id="shop-ui">
        <h2 style="margin:0 0 10px 0; color:var(--item); font-size:16px;">MERCADOR DE ALMAS</h2>
        <div id="shop-items" class="shop-grid"></div>
        <button onclick="game.closeShop()" style="margin-top:15px; background:#333; border:none; color:#fff; padding:10px;">FECHAR</button>
      </div>
    </div>

    <div id="controls">
      <div class="dpad">
        <button class="btn" id="b-u">▲</button>
        <button class="btn" id="b-l">◄</button>
        <button class="btn" id="b-r">►</button>
        <button class="btn" id="b-d">▼</button>
      </div>
      <div class="actions">
        <button class="btn btn-act" id="b-atk" style="border-left-color:var(--enemy)">⚔ ATACAR</button>
        <button class="btn btn-act" id="b-dash" style="border-left-color:#5ff">⚡ DASH (<span id="u-dsh">0</span>)</button>
        <button class="btn btn-act" id="b-sho" style="border-left-color:#ff5">➳ TIRO (<span id="u-arw">0</span>)</button>
      </div>
    </div>
  </div>
</div>

<script>
const game = {
  W: 36, H: 18, visRange: 5,
  player: { hp: 100, mHp: 100, dmg: 10, def: 1, lvl: 1, xp: 0, nXp: 50, flr: 1, gld: 0, arw: 8, dash: 0, x: 0, y: 0, f: [1, 0] },
  enemies: [], items: [], projs: [], map: [], explored: [],
  
  enemyPool: [
    { s: 'r', n: 'Rato', hp: 15, dmg: 5, xp: 10, g: [2,5], minF: 1 },
    { s: 'Z', n: 'Zumbi', hp: 35, dmg: 8, xp: 18, g: [4,8], minF: 1 },
    { s: 'G', n: 'Goblin', hp: 25, dmg: 12, xp: 22, g: [6,12], minF: 4 },
    { s: 'S', n: 'Esqueleto', hp: 45, dmg: 14, xp: 30, g: [8,15], minF: 7 },
    { s: 'M', n: 'Mago', hp: 40, dmg: 20, xp: 40, g: [12,20], minF: 10 },
    { s: 'O', n: 'Ogro', hp: 90, dmg: 25, xp: 60, g: [20,40], minF: 12 },
    { s: 'Ω', n: 'GUARDIÃO', hp: 300, dmg: 35, xp: 500, g: [100,200], isBoss: true }
  ],

  shopInventory: [
    { n: "Cura Total", c: 20, f: () => { game.player.hp = game.player.mHp; } },
    { n: "Flechas x8", c: 12, f: () => { game.player.arw += 8; } },
    { n: "Afiagem (ATK+4)", c: 30, f: () => { game.player.dmg += 4; } },
    { n: "Placa (DEF+2)", c: 40, f: () => { game.player.def += 2; } },
    { n: "Treino (XP+50)", c: 25, f: () => { game.gainXp(50); } }
  ],

  init() {
    const b = (id, fn) => { 
        const el = document.getElementById(id);
        el.onmousedown = el.ontouchstart = (e) => { e.preventDefault(); fn(); };
    };
    b('b-u', () => this.handleIn('w')); b('b-d', () => this.handleIn('s'));
    b('b-l', () => this.handleIn('a')); b('b-r', () => this.handleIn('d'));
    b('b-atk', () => this.handleIn(' ')); b('b-sho', () => this.handleIn('f'));
    b('b-dash', () => this.handleIn('q'));
    window.onkeydown = (e) => this.handleIn(e.key);
    this.genFloor();
    setInterval(() => this.loop(), 200);
  },

  genFloor() {
    this.map = Array.from({length:this.H}, () => Array(this.W).fill('#'));
    this.explored = Array.from({length:this.H}, () => Array(this.W).fill(false));
    this.enemies = []; this.items = []; this.projs = [];
    
    if (this.player.flr % 10 === 0) { // BOSS FLOOR
        this.genBossRoom();
    } else {
        this.genNormalFloor();
    }
    this.updateVis();
    this.draw();
  },

  genNormalFloor() {
    let rooms = [];
    for(let i=0; i<7; i++){
      let w = this.r(5,9), h = this.r(4,6);
      let x = this.r(1, this.W-w-1), y = this.r(1, this.H-h-1);
      if(this.map[y][x] === '#'){
        for(let yy=y; yy<y+h; yy++) for(let xx=x; xx<x+w; xx++) this.map[yy][xx] = '.';
        rooms.push({cx: x+Math.floor(w/2), cy: y+Math.floor(h/2), x, y, w, h});
      }
    }
    for(let i=1; i<rooms.length; i++){
      let x = rooms[i-1].cx, y = rooms[i-1].cy;
      while(x !== rooms[i].cx){ this.map[y][x] = '.'; x += (x < rooms[i].cx ? 1 : -1); }
      while(y !== rooms[i].cy){ this.map[y][x] = '.'; y += (y < rooms[i].cy ? 1 : -1); }
    }
    this.player.x = rooms[0].cx; this.player.y = rooms[0].cy;
    this.map[rooms[rooms.length-1].cy][rooms[rooms.length-1].cx] = '<';
    if(Math.random() > 0.4) this.map[rooms[1].cy][rooms[1].cx] = 'T';

    const scale = 1 + (this.player.flr * 0.18);
    const pool = this.enemyPool.filter(e => !e.isBoss && this.player.flr >= (e.minF || 0));
    rooms.forEach((rm, i) => {
        if(i===0) return;
        let d = pool[this.r(0, pool.length-1)];
        this.enemies.push({...d, x: rm.cx, y: rm.cy, hp: Math.floor(d.hp*scale), dmg: Math.floor(d.dmg*scale)});
        if(Math.random() > 0.6) this.items.push({x:rm.x+1, y:rm.y+1, t: Math.random()>0.5?'P':'A'});
    });
  },

  genBossRoom() {
    for(let y=4; y<this.H-4; y++) for(let x=6; x<this.W-6; x++) this.map[y][x] = '.';
    this.player.x = 8; this.player.y = 9;
    const bDef = this.enemyPool.find(e => e.isBoss);
    const scale = 1 + (this.player.flr/10);
    this.enemies.push({...bDef, x: 28, y: 9, hp: Math.floor(bDef.hp*scale), dmg: Math.floor(bDef.dmg*scale)});
    this.log("O GUARDIÃO DESPERTOU!", "#f55");
  },

  handleIn(k) {
    if(document.getElementById('shop-ui').style.display === 'flex') return;
    let dx = 0, dy = 0;
    const key = k.toLowerCase();
    if(key === 'w' || key === 'arrowup') dy = -1;
    if(key === 's' || key === 'arrowdown') dy = 1;
    if(key === 'a' || key === 'arrowleft') dx = -1;
    if(key === 'd' || key === 'arrowright') dx = 1;

    if(dx || dy) {
      this.player.f = [dx, dy];
      this.movePlayer(dx, dy);
    }
    if(key === ' ' || key === 'enter') this.melee();
    if(key === 'f') this.shoot();
    if(key === 'q') this.doDash();
    this.draw();
  },

  movePlayer(dx, dy) {
    const nx = this.player.x + dx, ny = this.player.y + dy;
    const en = this.enemies.find(e => e.x === nx && e.y === ny);
    if(en) this.combat(en);
    else if(this.canGo(nx, ny)) {
        this.player.x = nx; this.player.y = ny;
        this.updateVis(); this.checkTile(nx, ny);
        if(this.player.dash > 0) this.player.dash--;
    }
  },

  doDash() {
    if(this.player.dash > 0) return this.log("Dash em recarga!");
    const dx = this.player.f[0] * 2, dy = this.player.f[1] * 2;
    const nx = this.player.x + dx, ny = this.player.y + dy;
    if(this.canGo(nx, ny)) {
        this.player.x = nx; this.player.y = ny;
        this.player.dash = 3;
        this.updateVis();
        this.log("DASH! ⚡", "#5ff");
    }
  },

  canGo(x, y) { return x>=0 && y>=0 && x<this.W && y<this.H && this.map[y][x] !== '#'; },

  combat(en) {
    const d = Math.max(1, this.player.dmg + this.r(-2, 4));
    en.hp -= d;
    this.log(`Bateu no ${en.n}: -${d}HP`, "#fff");
    if(en.hp <= 0) {
        this.log(`Eliminado: ${en.n}`, "#4f4");
        this.player.gld += this.r(en.g[0], en.g[1]);
        if(en.isBoss) this.map[en.y][en.x] = '<';
        this.enemies = this.enemies.filter(e => e !== en);
        this.gainXp(en.xp);
    } else {
        const ed = Math.max(1, en.dmg - this.player.def);
        this.player.hp -= ed;
        this.log(`${en.n} atacou: -${ed}HP`, "#f55");
        this.shake();
    }
    if(this.player.hp <= 0) location.reload();
  },

  melee() {
    const tx = this.player.x + this.player.f[0], ty = this.player.y + this.player.f[1];
    const en = this.enemies.find(e => e.x === tx && e.y === ty);
    if(en) this.combat(en);
  },

  shoot() {
    if(this.player.arw > 0) {
        this.player.arw--;
        this.projs.push({x: this.player.x, y: this.player.y, dx: this.player.f[0], dy: this.player.f[1]});
    }
  },

  updateVis() {
    for(let y=0; y<this.H; y++) for(let x=0; x<this.W; x++) {
        const d = Math.sqrt((x-this.player.x)**2 + (y-this.player.y)**2);
        if(d <= this.visRange) this.explored[y][x] = true;
    }
  },

  checkTile(x, y) {
    const t = this.map[y][x];
    if(t === '<') { this.player.flr++; this.genFloor(); }
    if(t === 'T') this.openShop();
    const it = this.items.find(i => i.x === x && i.y === y);
    if(it) {
        if(it.t === 'P') this.player.hp = Math.min(this.player.mHp, this.player.hp+40);
        if(it.t === 'A') this.player.arw += 8;
        this.items = this.items.filter(i => i !== it);
    }
  },

  gainXp(v) {
    this.player.xp += v;
    if(this.player.xp >= this.player.nXp) {
        this.player.lvl++; this.player.xp = 0; this.player.nXp *= 1.6;
        this.player.mHp += 25; this.player.hp = this.player.mHp; this.player.dmg += 4;
        this.log("LEVEL UP!", "#ff5");
    }
  },

  openShop() {
    const container = document.getElementById('shop-items');
    container.innerHTML = '';
    this.shopInventory.forEach((it, i) => {
        const d = document.createElement('div'); d.className = 'shop-item';
        d.innerHTML = `<span>${it.n} (${it.c}g)</span> <button class="buy-btn" onclick="game.buy(${i})">$</button>`;
        container.appendChild(d);
    });
    document.getElementById('shop-ui').style.display = 'flex';
  },
  buy(i) {
    const it = this.shopInventory[i];
    if(this.player.gld >= it.c) { this.player.gld -= it.c; it.f(); this.openShop(); this.log("Comprado!"); }
  },
  closeShop() { document.getElementById('shop-ui').style.display = 'none'; },

  loop() {
    this.projs.forEach((p, i) => {
        p.x += p.dx; p.y += p.dy;
        const en = this.enemies.find(e => e.x === p.x && e.y === p.y);
        if(en) { 
            en.hp -= Math.floor(this.player.dmg * 0.9); 
            if(en.hp<=0) { this.gainXp(en.xp); this.enemies=this.enemies.filter(e=>e!==en); if(en.isBoss) this.map[en.y][en.x]='<'; }
            this.projs.splice(i,1); 
        } else if(!this.canGo(p.x, p.y)) this.projs.splice(i,1);
    });

    if(Math.random() > 0.6) {
        this.enemies.forEach(e => {
            const d = Math.abs(this.player.x-e.x) + Math.abs(this.player.y-e.y);
            let mx=0, my=0;
            if(d < 6) { // IA Perseguição
                if(Math.abs(this.player.x-e.x) > Math.abs(this.player.y-e.y)) mx = Math.sign(this.player.x-e.x);
                else my = Math.sign(this.player.y-e.y);
            } else { // Aleatório
                if(Math.random()>0.5) mx = Math.random()>0.5?1:-1; else my = Math.random()>0.5?1:-1;
            }
            const nx = e.x+mx, ny = e.y+my;
            if(this.canGo(nx, ny) && !this.enemies.find(o=>o!==e && o.x===nx && o.y===ny) && !(nx===this.player.x && ny===this.player.y)) {
                e.x = nx; e.y = ny;
            }
        });
    }
    this.draw();
  },

  draw() {
    let out = "";
    for(let y=0; y<this.H; y++) {
      for(let x=0; x<this.W; x++) {
        if(!this.explored[y][x]) { out += " "; continue; }
        const d = Math.sqrt((x-this.player.x)**2 + (y-this.player.y)**2);
        const vis = d <= this.visRange;
        const en = this.enemies.find(e => e.x === x && e.y === y);
        const it = this.items.find(i => i.x === x && i.y === y);
        const pr = this.projs.find(p => p.x === x && p.y === y);
        
        if(x===this.player.x && y===this.player.y) out += `<span class="p">@</span>`;
        else if(vis && en) out += `<span class="e">${en.s}</span>`;
        else if(vis && it) out += `<span class="i">${it.t}</span>`;
        else if(vis && pr) out += `*`;
        else {
          const t = this.map[y][x], s = vis ? "" : "opacity:0.25";
          if(t==='#') out += `<span class="w" style="${s}">#</span>`;
          else if(t==='<') out += `<span class="s" style="${s}">≡</span>`;
          else if(t==='T') out += `<span class="i" style="${s}">T</span>`;
          else out += `<span class="f" style="${s}">.</span>`;
        }
      }
      out += "\n";
    }
    document.getElementById('ascii-map').innerHTML = out;
    document.getElementById('u-hp').innerText = this.player.hp + "/" + this.player.mHp;
    document.getElementById('u-atkdef').innerText = this.player.dmg + "/" + this.player.def;
    document.getElementById('u-flr').innerText = this.player.flr;
    document.getElementById('u-gld').innerText = this.player.gld;
    document.getElementById('u-arw').innerText = this.player.arw;
    document.getElementById('u-dsh').innerText = this.player.dash === 0 ? "PRONTO" : this.player.dash;
  },

  log(m, c="#888") {
    const l = document.getElementById('msg-log');
    l.innerHTML = `<span style="color:${c}">${m}</span><br>` + l.innerHTML;
  },
  shake() {
    const v = document.getElementById('map-view');
    v.classList.add('shake'); setTimeout(() => v.classList.remove('shake'), 150);
  },
  r: (a, b) => Math.floor(Math.random() * (b - a + 1)) + a
};
game.init();
</script>
</body>
  </html>
  

